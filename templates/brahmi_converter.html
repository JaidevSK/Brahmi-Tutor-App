
{% extends "base.html" %}

{% block content %}
  <h1>Roman Script to Ashokan Brahmi Converter</h1>
  
  <form id="convertForm">
    <textarea id="romanInput" placeholder="Start typing in roman script..." rows="8" style="width:100%;">devaanaaMpiyasa piyadasino asokaaraajaa</textarea>
    <br />
    <button type="submit" class="convert-button" style="
      background-color: #3bfc00;
      color: rgb(0, 0, 0);
      font-size: 18px;
      font-weight: bold;
      padding: 15px 30px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin: 20px 0;
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      transition: all 0.3s ease;
    "
    >Convert to Brahmi Script</button>
  </form>

  <a id="downloadLink" class="download-link" style="
    display: none;
    background-color: #ff00f2;
    color: white;
    text-decoration: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    margin: 20px auto;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
    cursor: pointer;
  " 
  download="brahmi_output.txt" href="#">
    Download Result as Text File
  </a>

  <div class="output-container" id="brahmiOutput" aria-live="polite" aria-atomic="true" style="
    background: linear-gradient(135deg, #f15c05 0%, #f5f100 100%);
    border: 2px solid #e0e6ed;
    border-radius: 15px;
    padding: 30px;
    margin: 20px 0;
    font-family: 'Noto Sans Brahmi', serif;
    font-size: 24px;
    line-height: 1.8;
    text-align: center;
    color: #2c3e50;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    word-wrap: break-word;
    transition: all 0.3s ease;
  "></div>


  <script>
    const VOWEL_SIGNS = {
    'a': '', 'aa': 'ð‘€¸', 'i': 'ð‘€º', 'ii': 'ð‘€»', 'u': 'ð‘€¼', 'uu': 'ð‘€½', 'R^i': 'ð‘€¾', 'RR^i': 'ð‘€¿', 'L^i':'ð‘€', 'Ll^i':'ð‘', 'e': 'ð‘‚', 'ai': 'ð‘ƒ', 'o': 'ð‘„', 'au': 'ð‘…',
    };

    const FULL_VOWELS = {
    'a': 'ð‘€…', 'aa': 'ð‘€†', 'i': 'ð‘€‡', 'ii': 'ð‘€ˆ', 'u': 'ð‘€‰', 'uu': 'ð‘€Š', 'R^i': 'ð‘€‹', 'RR^i': 'ð‘€Œ', 'L^i':'ð‘€', 'Ll^i':'ð‘€Ž', 'e': 'ð‘€', 'ai': 'ð‘€', 'o': 'ð‘€‘', 'au': 'ð‘€’',
    };

    const CONSONANTS = {
    'k': 'ð‘€“',  'kh': 'ð‘€”', 'g': 'ð‘€•', 'gh': 'ð‘€–', 'G': 'ð‘€—',
    'c': 'ð‘€˜', 'ch': 'ð‘€™',  'j': 'ð‘€š', 'jh': 'ð‘€›', 'J': 'ð‘€œ',
    'T': 'ð‘€','Th': 'ð‘€ž', 'D': 'ð‘€Ÿ', 'Dh': 'ð‘€ ','N': 'ð‘€¡', 
    't': 'ð‘€¢','th': 'ð‘€£', 'd': 'ð‘€¤', 'dh':'ð‘€¥', 'n': 'ð‘€¦',
    'p': 'ð‘€§', 'ph': 'ð‘€¨', 'b': 'ð‘€©', 'bh': 'ð‘€ª', 'm': 'ð‘€«',
    'y': 'ð‘€¬', 'r': 'ð‘€­', 'l': 'ð‘€®', 'v': 'ð‘€¯',
    'sh': 'ð‘€°', 'Sh': 'ð‘€±', 's': 'ð‘€²', 'h': 'ð‘€³', 'L': 'ð‘€´', 
    };

    const SPECIALS = {
    'M': 'ð‘€',  
    'H': 'ð‘€‚',   
    ' ': ' ',    
    '0': 'ð‘¦', '1': 'ð‘§', '2': 'ð‘¨', '3': 'ð‘©', '4': 'ð‘ª', '5': 'ð‘«', '6': 'ð‘¬', '7': 'ð‘­', '8': 'ð‘®', '9': 'ð‘¯',
    '.': 'ð‘‡', ',': ',', ':': ':', ';': ';', '?': '?', '!': '!', '(': '(', ')': ')', '-': '-'
    };

  const orderTokens = (obj) => Object.keys(obj).sort((a,b) => b.length - a.length);
  const VOWEL_TOKENS = orderTokens(VOWEL_SIGNS);
  const FULL_VOWEL_TOKENS = orderTokens(FULL_VOWELS);
  const CONSONANT_TOKENS = orderTokens(CONSONANTS);
  const SPECIAL_TOKENS = orderTokens(SPECIALS);

  function convertToBrahmi(romanText) {
    if (!romanText) return "No text entered.";
    let output = '';
    let i = 0;

    while (i < romanText.length) {
      let matched = false;

      // 1. Try consonants
      for (const token of CONSONANT_TOKENS) {
        if (romanText.startsWith(token, i)) {
          const consonantChar = CONSONANTS[token];
          i += token.length;

          // Lookahead matra or special ending
          let matraFound = false;
          const matraTokens = [...VOWEL_TOKENS, 'M', 'H'];
          for (const mToken of matraTokens) {
            if (romanText.startsWith(mToken, i)) {
              if (mToken === 'M') {
                output += consonantChar + SPECIALS['M'];
              } else if (mToken === 'H') {
                output += consonantChar + SPECIALS['H'];
              } else {
                output += consonantChar + VOWEL_SIGNS[mToken];
              }
              i += mToken.length;
              matraFound = true;
              break;
            }
          }
          if (!matraFound) {
            let nextIsConsonant = false;
            for (const nextCons of CONSONANT_TOKENS) {
              if (romanText.startsWith(nextCons, i)) {
                nextIsConsonant = true;
                break;
              }
            }
            if (nextIsConsonant || i === romanText.length || romanText[i] === ' ') {
              output += consonantChar + 'ð‘†';
            } else {
              output += consonantChar;
            }
          }
          matched = true;
          break;
        }
      }
      if (matched) continue;

      // 2. Try full vowels
      for (const token of FULL_VOWEL_TOKENS) {
        if (romanText.startsWith(token, i)) {
          output += FULL_VOWELS[token];
          i += token.length;
          matched = true;
          break;
        }
      }
      if (matched) continue;

      // 3. Try special characters
      for (const token of SPECIAL_TOKENS) {
        if (romanText.startsWith(token, i)) {
          output += SPECIALS[token];
          i += token.length;
          matched = true;
          break;
        }
      }
      if (matched) continue;

      // Fallback
      output += romanText[i];
      i++;
    }
    return output;
  }

  const form = document.getElementById('convertForm');
  const input = document.getElementById('romanInput');
  const outputDiv = document.getElementById('brahmiOutput');
  const downloadLink = document.getElementById('downloadLink');

  function utf8ToUri(str) {
    return encodeURIComponent(str).replace(/'/g, "%27").replace(/"/g, "%22");
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const romanText = input.value.trim();
    if (romanText.length === 0) {
      outputDiv.textContent = "Please enter some text to convert.";
      downloadLink.style.display = "none";
      return;
    }
    const converted = convertToBrahmi(romanText);
    outputDiv.textContent = converted;
    downloadLink.href = "data:text/plain;charset=utf-8," + utf8ToUri(converted);
    downloadLink.style.display = "inline-block";
  });

  window.onload = () => {
    outputDiv.textContent = convertToBrahmi(input.value.trim());
    downloadLink.href = "data:text/plain;charset=utf-8," + utf8ToUri(outputDiv.textContent);
    downloadLink.style.display = "inline-block";
  };
</script>
{% endblock %}
